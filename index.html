<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

    <style>
      body { margin: 0; overflow: hidden; font-family: 'IM Fell English SC', serif; }
      #scanning-overlay {
        position: absolute; top: 0; left: 0; width: 100vw; height: 100vh;
        background: rgba(0,0,0,0.8); color: white; display:flex;
        align-items:center; justify-content:center; z-index:9999; font-size:1.3em;
      }
      #next-button {
        position:absolute; bottom:20px; right:20px;
        background:white; border:none; padding:10px 15px;
        border-radius:6px; font-weight:bold; cursor:pointer; display:none;
        z-index:10000;
      }
    </style>

    <script>
      AFRAME.registerComponent('touch-rotation', {
        schema:{speed:{default:1}},
        init:function(){
          this.startX=0;this.rotationY=0;this.isDragging=false;
          this.handleTouchStart=this.handleTouchStart.bind(this);
          this.handleTouchMove=this.handleTouchMove.bind(this);
          this.handleTouchEnd=this.handleTouchEnd.bind(this);
          this.el.sceneEl.canvas.addEventListener('touchstart',this.handleTouchStart);
          this.el.sceneEl.canvas.addEventListener('touchmove',this.handleTouchMove);
          this.el.sceneEl.canvas.addEventListener('touchend',this.handleTouchEnd);
        },
        remove:function(){
          this.el.sceneEl.canvas.removeEventListener('touchstart',this.handleTouchStart);
          this.el.sceneEl.canvas.removeEventListener('touchmove',this.handleTouchMove);
          this.el.sceneEl.canvas.removeEventListener('touchend',this.handleTouchEnd);
        },
        handleTouchStart:function(e){
          if(e.touches.length===1){
            this.isDragging=true;
            this.startX=e.touches[0].pageX;
            this.rotationY=this.el.getAttribute('rotation').y;
          }
        },
        handleTouchMove:function(e){
          if(this.isDragging && e.touches.length===1){
            const deltaX=e.touches[0].pageX-this.startX;
            const newY=this.rotationY+deltaX*0.5*this.data.speed;
            this.el.setAttribute('rotation',{x:0,y:newY,z:0});
          }
        },
        handleTouchEnd:function(){this.isDragging=false;}
      });

      document.addEventListener("DOMContentLoaded",()=>{
        const scene = document.querySelector("a-scene");
        const overlay = document.querySelector("#scanning-overlay");
        const nextButton = document.querySelector("#next-button");

        let persistentEntity = null;
        const target = document.querySelector("[mindar-image-target]");

        target.addEventListener("targetFound",()=>{
          overlay.style.display="none";
          nextButton.style.display="block";

          const videoEl = target.querySelector("a-video");
          const modelEl = target.querySelector("[gltf-model]");
          const vid = document.querySelector(videoEl.getAttribute("src"));

          // reproducir video
          vid.play();
          videoEl.setAttribute("visible",true);

          // si a√∫n no existe el contenido persistente, crearlo
          if(!persistentEntity){
            persistentEntity = document.createElement("a-entity");
            persistentEntity.id = "persistent-content";
            persistentEntity.setAttribute("position","0 0 -1.2"); // visible frente a la c√°mara
            persistentEntity.setAttribute("rotation","0 0 0");

            // clonar modelo y video
            const clonedModel = modelEl.cloneNode(true);
            const clonedVideo = videoEl.cloneNode(true);

            clonedModel.setAttribute("visible","true");
            clonedVideo.setAttribute("visible","true");

            persistentEntity.appendChild(clonedModel);
            persistentEntity.appendChild(clonedVideo);
            scene.appendChild(persistentEntity);
          }
        });

        // mientras el target est√© visible, actualizamos posici√≥n y rotaci√≥n
        scene.addEventListener("loaded",()=>{
          scene.addEventListener("renderstart",()=>{
            scene.renderer.setAnimationLoop(()=>{
              if(persistentEntity && target.object3D.visible){
                const pos = target.object3D.position;
                const quat = target.object3D.quaternion;
                persistentEntity.object3D.position.copy(pos);
                persistentEntity.object3D.quaternion.copy(quat);
              }
            });
          });
        });

        target.addEventListener("targetLost",()=>{
          // cuando se pierde el target, el contenido se queda donde estaba
        });

        nextButton.addEventListener("click",()=>{
          if(persistentEntity){
            persistentEntity.parentNode.removeChild(persistentEntity);
            persistentEntity=null;
          }
          overlay.style.display="flex";
          nextButton.style.display="none";
          alert("üìñ Aqu√≠ podr√≠as cargar la siguiente p√°gina del cuento");
        });
      });
    </script>
  </head>

  <body>
    <div id="scanning-overlay">üìñ Escanea la p√°gina del cuento ‚ú®</div>
    <button id="next-button">‚û°Ô∏è Siguiente p√°gina</button>

    <a-scene
      mindar-image="imageTargetSrc: ./cuento1.mind; maxTrack: 1"
      color-space="sRGB"
      renderer="colorManagement:true, physicallyCorrectLights"
      vr-mode-ui="enabled:false"
      device-orientation-permission-ui="enabled:false"
      embedded>

      <a-camera position="0 0 0" look-controls="enabled:false"></a-camera>

      <a-entity mindar-image-target="targetIndex: 0">
        <a-entity gltf-model="#escena1Model" position="0 -0.3 0" scale="0.1 0.1 0.1" touch-rotation></a-entity>
        <a-video id="video1" src="#animacion1" width="1.3" height="0.75"
                 position="0 0.6 0" autoplay="false" loop="true" visible="false"></a-video>
      </a-entity>
    </a-scene>

    <a-assets>
      <video id="animacion1" src="./pagina1.mp4" preload="auto" loop="true" playsinline crossorigin="anonymous"></video>
      <a-asset-item id="escena1Model" src="./Escena1.glb"></a-asset-item>
    </a-assets>
  </body>
</html>
