<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/aframe-event-set-component@5.0.0/dist/aframe-event-set-component.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/aframe-orbit-controls@1.3.0/dist/aframe-orbit-controls.min.js"></script>

    <style>
      body { margin: 0; overflow: hidden; font-family: sans-serif; }

      /* ðŸ“˜ Cuadro del cuento */
      #menu {
        position: fixed;
        bottom: 10px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0,0,0,0.7);
        padding: 15px 20px;
        border-radius: 15px;
        color: white;
        z-index: 999;
        text-align: center;
        width: 85%;
        max-width: 420px;
        display: none;
      }
      #menu button {
        margin: 5px;
        padding: 8px 15px;
        border: none;
        border-radius: 10px;
        background: #1e90ff;
        color: white;
        font-weight: bold;
        cursor: pointer;
      }
      #menu button:hover { background: #4682b4; }
      #story-box { margin-top: 10px; font-size: 15px; line-height: 1.4; }

      /* ðŸ§­ Mensaje de escaneo */
      #scan-message {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0,0,0,0.75);
        padding: 12px 18px;
        border-radius: 12px;
        color: white;
        text-align: center;
        z-index: 1000;
      }
      #scan-message img {
        display: block;
        margin: 10px auto 0 auto;
        max-width: 150px;
        border-radius: 8px;
      }

      /* ðŸŽ® Controles */
      #controls {
        position: fixed;
        bottom: 120px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 1000;
        display: flex;
        gap: 10px;
      }
      #controls button {
        padding: 6px 12px;
        border: none;
        border-radius: 8px;
        background: #444;
        color: white;
        cursor: pointer;
      }
      #controls button:hover { background: #666; }

      /* âœ¨ Botones de cambio de modo */
      #mode-switch {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1500;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      #mode-switch button {
        padding: 10px 16px;
        border: none;
        border-radius: 12px;
        background: linear-gradient(135deg, #6dd5fa, #2980b9);
        color: white;
        font-weight: bold;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(0,0,0,0.25);
        transition: transform 0.15s ease, box-shadow 0.2s ease;
      }
      #mode-switch button:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(0,0,0,0.3); }
      #mode-switch button:active { transform: scale(0.95); box-shadow: 0 3px 8px rgba(0,0,0,0.2); }

      /* ðŸŒ™ Pantalla de inicio */
      #start-screen {
        position: fixed;
        inset: 0;
        background: radial-gradient(circle at center, #000428, #004e92);
        color: white;
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        z-index: 2000;
        text-align: center;
      }
      #start-content img#cover-image {
        width: 200px;
        max-width: 70%;
        margin-bottom: 15px;
        border-radius: 10px;
        box-shadow: 0 0 20px rgba(255,255,255,0.4);
      }
      #start-content h1 { font-size: 2em; margin: 10px 0 5px 0; }
      #start-content p { margin-bottom: 15px; color: #cce7ff; }
      #start-content button {
        margin: 5px;
        padding: 10px 20px;
        border: none;
        border-radius: 12px;
        background: #1e90ff;
        color: white;
        font-weight: bold;
        cursor: pointer;
        transition: background 0.3s;
      }
      #start-content button:hover { background: #4682b4; }

      /* ðŸŒŸ CrÃ©ditos */
      #credits-modal {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.7);
        z-index: 2100;
        justify-content: center;
        align-items: center;
      }
      #credits-box {
        background: #fff;
        color: #000;
        padding: 20px 30px;
        border-radius: 12px;
        text-align: center;
        max-width: 300px;
      }
      #credits-box h2 { margin-top: 0; color: #1e90ff; }
      #credits-box button {
        margin-top: 10px;
        padding: 6px 12px;
        border: none;
        border-radius: 8px;
        background: #1e90ff;
        color: white;
        cursor: pointer;
      }
      #credits-box button:hover { background: #4682b4; }

      /* ðŸ”Š BotÃ³n de audio */
      #btnAudio {
        position: fixed;
        top: -30px;
        right: -70px;
        z-index: 1200;
        background: rgba(30,144,255,0.9);
        color: white;
        font-size: 22px;
        border: none;
        border-radius: 50%;
        width: 48px;
        height: 48px;
        cursor: pointer;
        box-shadow: 0 0 10px rgba(0,0,0,0.3);
        display: none;
      }
      #btnAudio:hover { background: #4682b4; }
      button.disabled { opacity: 0.4; pointer-events: none; }
    </style>
  </head>

  <body>
    <!-- Pantalla de inicio -->
    <div id="start-screen">
      <div id="start-content">
        <img src="./portada.png" alt="Portada" id="cover-image">
        <h1>ðŸŒ™ Mauro y la Luna</h1>
        <p>Un cuento en Realidad Aumentada</p>
        <button id="btnStartStory">Iniciar cuento</button>
        <button id="btnCredits">CrÃ©ditos</button>
      </div>
    </div>

    <!-- CrÃ©ditos -->
    <div id="credits-modal">
      <div id="credits-box">
        <h2>CrÃ©ditos</h2>
        <p><strong>Autor:</strong> Equipo dinamita</p>
        <p><strong>Modelado 3D:</strong> Sofi y Anne</p>
        <p><strong>Arte:</strong> Lucy</p>
        <p><strong>Desarrollo:</strong> Raquel</p>
        <button id="btnCloseCredits">Cerrar</button>
      </div>
    </div>

    <!-- Mensaje de escaneo -->
    <div id="scan-message">
      Escanea una pÃ¡gina del cuento ðŸ“–
      <img id="scan-image" src="./page1.png" alt="PÃ¡gina del cuento">
    </div>

    <!-- Cuadro del cuento -->
    <div id="menu">
      <div id="story-box"></div>
      <div>
        <button id="btnPrev">âŸµ Anterior</button>
        <button id="btnNext">Siguiente âŸ¶</button>
      </div>
    </div>

    <!-- Controles de audio -->
    <div id="controls">
      <button id="btnAudio" title="Reproducir narraciÃ³n">ðŸ”Š</button>
    </div>

    <!-- Botones de modo -->
    <div id="mode-switch">
      <button id="enter3d">Modo 3D</button>
      <button id="enterAR" style="display:none;">Regresar a AR</button>
    </div>

    <!-- Escena A-Frame + MindAR -->
    <a-scene gesture-detector
             mindar-image="imageTargetSrc: ./cuento1.mind; maxTrack: 1"
             color-space="sRGB"
             renderer="colorManagement: true, physicallyCorrectLights"
             vr-mode-ui="enabled: false"
             device-orientation-permission-ui="enabled: false">

      <a-assets>
        <a-asset-item id="PageModel1" src="./escena1.glb"></a-asset-item>
        <a-asset-item id="PageModel2" src="./escena2.glb"></a-asset-item>
        <a-asset-item id="PageModel3" src="./escena3_2.glb"></a-asset-item>
        <a-asset-item id="PageModel4" src="./escena4.glb"></a-asset-item>
        <audio id="audio1" src="./audio1.mp3"></audio>
        <audio id="audio2" src="./audio2.mp3"></audio>
        <audio id="audio3" src="./audio3.mp3"></audio>
        <audio id="audio4" src="./audio4.mp3"></audio>
      </a-assets>

      <!-- Modelo libre modo 3D con Orbit Controls -->
      <a-entity id="freeModel" visible="false"
                position="0 0 0"
                scale="0.3 0.3 0.3"
                orbit-controls="target: 0 0 0; enablePan: false; enableDamping: true; dampingFactor: 0.1; rotateSpeed:0.5; minDistance:0.5; maxDistance:5;">
      </a-entity>

      <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

      <!-- PÃ¡gina 1 -->
      <a-entity id="target-page1" mindar-image-target="targetIndex: 0">
        <a-entity gltf-model="#PageModel1" scale="0.3 0.3 0.3"></a-entity>
      </a-entity>

      <!-- PÃ¡gina 2 -->
      <a-entity id="target-page2" mindar-image-target="targetIndex: 1">
        <a-entity gltf-model="#PageModel2" scale="0.3 0.3 0.3"></a-entity>
      </a-entity>

      <!-- PÃ¡gina 3 -->
      <a-entity id="target-page3" mindar-image-target="targetIndex: 2">
        <a-entity gltf-model="#PageModel3" scale="0.3 0.3 0.3"></a-entity>
      </a-entity>

      <!-- PÃ¡gina 4 -->
      <a-entity id="target-page4" mindar-image-target="targetIndex: 3">
        <a-entity gltf-model="#PageModel4" scale="0.3 0.3 0.3"></a-entity>
      </a-entity>

    </a-scene>

    <script>
      // Variables bÃ¡sicas
      const storyBox = document.querySelector("#story-box");
      const menu = document.querySelector("#menu");
      const scanMessage = document.querySelector("#scan-message");
      const btnNext = document.querySelector("#btnNext");
      const btnPrev = document.querySelector("#btnPrev");
      const btnAudio = document.getElementById("btnAudio");
      const freeModel = document.getElementById("freeModel");
      const btn3D = document.getElementById("enter3d");
      const btnAR = document.getElementById("enterAR");
      const sceneEl = document.querySelector("a-scene");
      const modeSwitch = document.getElementById("mode-switch");

      let currentPage = null;
      let currentFragment = 0;
      let currentAudio = null;
      let arSystem;

      const storyPages = {
        0: ["HabÃ­a una vez un ratoncito llamado Mauro,", "que vivÃ­a en una madriguera cÃ¡lida bajo un roble viejo.", "Le encantaba salir por las noches a buscar semillasâ€¦", "pero habÃ­a algo que lo asustaba: Â¡La Luna!"],
        1: ["Grande, blanca y redonda,", "lo miraba desde lo alto con un brillo tan intenso que Mauro sentÃ­a que lo estaba juzgando.", "â€”Seguro se rÃ­e de mÃ­ porque soy pequeÃ±oâ€¦ â€”", "pensaba mientras corrÃ­a a esconderse entre las hojas."],
        2: ["Una noche, mientras huÃ­a apresurado,", "tropezÃ³ con una luciÃ©rnaga que brillaba tranquilamente sobre una piedra.", "â€”Â¿Por quÃ© corres asÃ­? â€”preguntÃ³ la luciÃ©rnaga.", "â€”La Luna me mira â€”susurrÃ³ Milo temblando.", "La luciÃ©rnaga soltÃ³ una risita luminosa.", "â€”Â¿Y quÃ© tiene de malo que alguien te mire?", "Tal vez no te estÃ¡ mirando para juzgarteâ€¦ sino para acompaÃ±arte."],
        3: ["Mauro se quedÃ³ pensando. Esa noche decidiÃ³ no esconderse.", "Se sentÃ³ en el pasto y mirÃ³ hacia el cielo.", "La Luna, muy despacio, brillÃ³ aÃºn mÃ¡s fuerteâ€¦ como si le sonriera.", "Y Mauro, por primera vez, le sonriÃ³ tambiÃ©n.", "Desde entonces, el pequeÃ±o ratÃ³n siguiÃ³ sintiendo miedo a veces, pero habÃ­a aprendido algo importante:", "La valentÃ­a no es no tener miedoâ€¦ es atreverse a mirar al miedo a los ojos y sonreÃ­rle de vuelta."]
      };

      const audioMap = {
        0: document.getElementById("audio1"),
        1: document.getElementById("audio2"),
        2: document.getElementById("audio3"),
        3: document.getElementById("audio4")
      };

      function showCurrentFragment() {
        if(currentPage !== null) {
          storyBox.innerText = storyPages[currentPage][currentFragment];
          menu.style.display = "block";
          scanMessage.style.display = "none";
        }
      }

      function hideAll() {
        menu.style.display = "none";
        scanMessage.style.display = "block";
      }

      function handlePageAudio(pageIndex) {
        if(currentAudio) { currentAudio.pause(); currentAudio.currentTime=0; }
        currentAudio = audioMap[pageIndex];
        btnAudio.style.display="block";
        btnAudio.textContent="ðŸ”Š";
      }

      btnAudio.addEventListener("click", () => {
        if(!currentAudio) return;
        if(currentAudio.paused){ currentAudio.play(); btnAudio.textContent="â¸ï¸"; }
        else { currentAudio.pause(); btnAudio.textContent="ðŸ”Š"; }
      });

      btnNext.addEventListener("click", () => {
        if(currentPage!==null){
          const frag = storyPages[currentPage];
          currentFragment = (currentFragment+1)%frag.length;
          showCurrentFragment();
        }
      });
      btnPrev.addEventListener("click", () => {
        if(currentPage!==null){
          const frag = storyPages[currentPage];
          currentFragment = (currentFragment-1+frag.length)%frag.length;
          showCurrentFragment();
        }
      });

      function setupTargetEvents(id,pageIndex){
        const el = document.querySelector(id);
        el.addEventListener("targetFound",()=>{
          currentPage=pageIndex;
          currentFragment=0;
          showCurrentFragment();
          handlePageAudio(pageIndex);
        });
        el.addEventListener("targetLost",()=>{
          currentPage=null;
          hideAll();
          if(currentAudio){ currentAudio.pause(); currentAudio.currentTime=0; btnAudio.style.display="none"; }
        });
      }
      setupTargetEvents("#target-page1",0);
      setupTargetEvents("#target-page2",1);
      setupTargetEvents("#target-page3",2);
      setupTargetEvents("#target-page4",3);

      // Inicializar AR
      sceneEl.addEventListener("loaded",()=>{ arSystem = sceneEl.systems["mindar-image-system"]; });

      // Pantalla de inicio
      document.getElementById("btnStartStory").addEventListener("click",()=>{
        document.getElementById("start-screen").style.display="none";
        scanMessage.style.display="block";
        document.getElementById("controls").style.display="flex";
        if(arSystem) arSystem.start();
      });

      // CrÃ©ditos
      document.getElementById("btnCredits").addEventListener("click"=>{ document.getElementById("credits-modal").style.display="flex"; });
      document.getElementById("btnCloseCredits").addEventListener("click"=>{ document.getElementById("credits-modal").style.display="none"; });

      // âž¤ Modo 3D
      btn3D.addEventListener("click",()=>{
        if(arSystem) arSystem.stop();
        document.querySelectorAll("[mindar-image-target]").forEach(t=>t.setAttribute("visible","false"));
        if(currentPage!==null){ freeModel.setAttribute("gltf-model",`#PageModel${currentPage+1}`); freeModel.setAttribute("visible","true"); }
        btn3D.style.display="none"; btnAR.style.display="inline-block";
      });

      // âž¤ Regresar AR
      btnAR.addEventListener("click",()=>{
        freeModel.setAttribute("visible","false");
        btn3D.style.display="inline-block"; btnAR.style.display="none";
        if(arSystem) arSystem.start();
      });

    </script>
  </body>
</html>
